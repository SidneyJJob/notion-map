<!DOCTYPE html>
<html>
  <head>
    <title>Notion Trip Map</title>
    <meta charset="utf-8">
    <style>
      #map {
        height: 100vh;
        width: 100%;
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAz6366teB2HIIxRi1MpJKcallback=initMap
    <script>
      async function initMap() {
        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 7,
          center: { lat: 13.7563, lng: 100.5018 },
        });

        const response = await fetch("https://docs.google.com/spreadsheets/d/1LWZ6rzNtjv3VoEfWmxEpGctNazN2ddpRYnslwcwoUnE/export?format=csv");
        const csvText = await response.text();
        const rows = csvText.split("\n").map(row => row.split(","));
        const headers = rows[0];
        const dataRows = rows.slice(1);

        const getIndex = name => headers.indexOf(name);
        const nameIdx = getIndex("行程景點");
        const addressIdx = getIndex("地址");
        const descIdx = getIndex("描述");
        const dayIdx = getIndex("Day");

        const fixedColors = {
          "Day1": "#FFC0CB",
          "Day2": "#FFFF00",
          "Day3": "#A52A2A",
          "Day4": "#808080",
          "Day5": "#FF0000",
          "Day6": "#0000FF"
        };

        const randomColorsPool = [
          "#00CED1", "#8A2BE2", "#FF8C00", "#32CD32", "#FF1493", "#4682B4",
          "#7FFF00", "#FF4500", "#DA70D6", "#20B2AA", "#FFD700", "#ADFF2F"
        ];

        const dayColorMap = { ...fixedColors };
        let usedColors = new Set(Object.values(fixedColors));
        let randomIndex = 0;

        for (const row of dataRows) {
          const name = row[nameIdx];
          const address = row[addressIdx];
          const desc = row[descIdx] || "（無描述）";
          const day = row[dayIdx];

          let color = "#000000"; // 預設黑色
          if (day) {
            if (!dayColorMap[day]) {
              while (randomIndex < randomColorsPool.length && usedColors.has(randomColorsPool[randomIndex])) {
                randomIndex++;
              }
              color = randomColorsPool[randomIndex % randomColorsPool.length];
              dayColorMap[day] = color;
              usedColors.add(color);
              randomIndex++;
            } else {
              color = dayColorMap[day];
            }
          }

          const geocoder = new google.maps.Geocoder();
          geocoder.geocode({ address: address }, (results, status) => {
            if (status === "OK" && results[0]) {
              const marker = new google.maps.Marker({
                map: map,
                position: results[0].geometry.location,
                title: name,
                icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  scale: 8,
                  fillColor: color,
                  fillOpacity: 0.8,
                  strokeWeight: 1,
                },
              });

              const infoWindow = new google.maps.InfoWindow({
                content: `<strong>${name}</strong><br><em>${day || "未分類"}</em><br>${desc}<br><small>${address}</small>`,
              });

              marker.addListener("click", () => {
                infoWindow.open(map, marker);
              });
            }
          });
        }
      }
    </script>
  </head>
  <body>
    <div id="map"></div>
  </body>
</html>
